<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Doctor Dashboard - PREGNACARE</title>
  <link rel="stylesheet" href="doctor_dashboard.css">
</head>
<body>

<div class="sidebar">
  <h2>PREGNACARE</h2>
  <h3 id="doctorName">Doctor</h3>
  <button onclick="showSection('patientsSection')">Patients</button>
  <button onclick="showSection('chatSection')">Chat</button>
  <button onclick="showSection('registerSection')">Register Pregnancy</button>
  <button onclick="showSection('changePasswordSection')">Change Password</button>
  <button id="logoutBtn" class="logout">Logout</button>
</div>

<div class="main">
  <div class="greeting" id="greetingText">Hello Doctor !!</div>

  <!-- Patients List -->
  <div id="patientsSection" class="section">
    <h2>Patients Assigned</h2>
    <ul id="patientList"></ul>
  </div>

  <!-- Chat Section -->
  <div id="chatSection" class="section" style="display: none;">
    <h2>Chat with Patient</h2>
    <select id="patientSelect">
      <option value="">Select Patient</option>
    </select>
    <div id="chatMessages" class="chat-box"></div>
    <input type="text" id="chatInput" placeholder="Type a message...">
    <button onclick="sendMessage()">Send</button>
  </div>

  <!-- Register Pregnancy Section -->
  <div id="registerSection" class="section" style="display: none;">
    <h2>Register New Pregnancy</h2>
    <form id="pregnancyForm">
      <div class="form-row">
        <input type="text" id="firstName" placeholder="First Name" required>
        <input type="text" id="middleName" placeholder="Middle Name">
        <input type="text" id="lastName" placeholder="Last Name" required>
      </div>
      <div class="form-row">
        <input type="number" id="age" placeholder="Age" required>
        <input type="date" id="dob" placeholder="Date of Birth" required>
      </div>
      <div class="form-row">
        <input type="text" id="mobile" placeholder="Mobile Number" required>
        <input type="text" id="husbandName" placeholder="Husband's Name" required>
      </div>
      <textarea id="address" placeholder="Address" required></textarea>
      <input type="email" id="email" placeholder="Email (optional)">
      <textarea id="medicalHistory" placeholder="Brief Medical History"></textarea>
      <button type="submit">Register Pregnancy</button>
    </form>
  </div>

  <!-- Change Password Section -->
  <div id="changePasswordSection" class="section" style="display: none;">
    <h2>Change Password</h2>
    <form id="changePasswordForm">
      <div class="form-row">
        <input type="password" id="currentPassword" placeholder="Current Password" required>
        <input type="password" id="newPassword" placeholder="New Password" required>
        <input type="password" id="confirmNewPassword" placeholder="Confirm New Password" required>
      </div>
      <button type="submit">Change Password</button>
    </form>
    <p id="passwordError" style="color: red; display: none;">Passwords do not match!</p>
    <p id="passwordSuccess" style="color: green; display: none;">Password changed successfully!</p>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut, EmailAuthProvider, reauthenticateWithCredential, updatePassword } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getFirestore, collection, query, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAAdjeTlV3QD7RNuhJeuIo8Vp2tftjbE1k",
  authDomain: "pregnacare-70aed.firebaseapp.com",
  projectId: "pregnacare-70aed",
  storageBucket: "pregnacare-70aed.firebasestorage.app",
  messagingSenderId: "375969305451",
  appId: "1:375969305451:web:82d4e1f90264cfa3f6f22e",
  measurementId: "G-34LJE5R27W"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const doctorNameSpan = document.getElementById('doctorName');
  const logoutBtn = document.getElementById('logoutBtn');
  const greetingText = document.getElementById('greetingText');
  const sections = document.querySelectorAll('.section');

  window.showSection = function(sectionId) {
    sections.forEach(section => section.style.display = 'none');
    document.getElementById(sectionId).style.display = 'block';
  };

  onAuthStateChanged(auth, async user => {
    if (user) {
      const doctorName = user.displayName || " ";
      doctorNameSpan.textContent = doctorName;
      greetingText.textContent = `Hello Doctor ${doctorName} !!`;
      await loadPatients();
    } else {
      window.location.href = "doctorlogin.html";
    }
  });

  logoutBtn.addEventListener('click', () => {
    signOut(auth).then(() => window.location.href = "doctorlogin.html");
  });

  async function loadPatients() {
    const patientList = document.getElementById('patientList');
    const patientSelect = document.getElementById('patientSelect');
    patientList.innerHTML = '<li>Loading...</li>';
    patientSelect.innerHTML = '<option value="">Select Patient</option>';

    const user = auth.currentUser;
    if (!user) return;

    const q = query(collection(db, 'patients'), where('assignedDoctorID', '==', user.uid));
    const snapshot = await getDocs(q);
    patientList.innerHTML = '';

    snapshot.forEach(doc => {
      const patient = doc.data();
      const name = patient.fullName || `${patient.firstName} ${patient.lastName}`;
      const li = document.createElement('li');
      li.textContent = name;
      patientList.appendChild(li);

      const option = document.createElement('option');
      option.value = doc.id;
      option.textContent = name;
      patientSelect.appendChild(option);
    });
  }

  window.sendMessage = function() {
    const messageBox = document.getElementById('chatMessages');
    const input = document.getElementById('chatInput');

    if (input.value.trim() !== '') {
      const newMessage = document.createElement('div');
      newMessage.textContent = `Doctor: ${input.value}`;
      messageBox.appendChild(newMessage);
      input.value = '';
      messageBox.scrollTop = messageBox.scrollHeight;
    }
  }

  document.getElementById('pregnancyForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = {
      firstName: document.getElementById('firstName').value.trim(),
      middleName: document.getElementById('middleName').value.trim(),
      lastName: document.getElementById('lastName').value.trim(),
      age: parseInt(document.getElementById('age').value.trim()),
      dob: document.getElementById('dob').value.trim(),
      mobile: document.getElementById('mobile').value.trim(),
      husbandName: document.getElementById('husbandName').value.trim(),
      address: document.getElementById('address').value.trim(),
      email: document.getElementById('email').value.trim(),
      medicalHistory: document.getElementById('medicalHistory').value.trim(),
      assignedDoctorID: auth.currentUser.uid
    };

    // Basic validation
    if (!formData.firstName || !formData.lastName || !formData.age || !formData.dob || !formData.mobile || !formData.husbandName || !formData.address) {
      alert('Please fill in all required fields.');
      return;
    }

    try {
      await addDoc(collection(db, 'patients'), formData);
      alert('Pregnancy Registered Successfully!');
      document.getElementById('pregnancyForm').reset();
      await loadPatients();
    } catch (error) {
      console.error(error);
      alert('Failed to register. Please try again.');
    }
  });

  document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const currentPassword = document.getElementById('currentPassword').value.trim();
    const newPassword = document.getElementById('newPassword').value.trim();
    const confirmNewPassword = document.getElementById('confirmNewPassword').value.trim();

    const passwordError = document.getElementById('passwordError');
    const passwordSuccess = document.getElementById('passwordSuccess');

    if (newPassword !== confirmNewPassword) {
      passwordError.style.display = 'block';
      passwordSuccess.style.display = 'none';
      return;
    }

    const user = auth.currentUser;
    const credential = EmailAuthProvider.credential(user.email, currentPassword);

    try {
      await reauthenticateWithCredential(user, credential);
      await updatePassword(user, newPassword);
      passwordSuccess.style.display = 'block';
      passwordError.style.display = 'none';
    } catch (error) {
      console.error(error);
      passwordError.style.display = 'block';
      passwordSuccess.style.display = 'none';
    }
  });
</script>

</body>
</html>
